# Fistful of Flaws

私たちは、ディメンショナルモデルのデザインレビューを依頼されることがよくあります。本稿では、レビューを行う際にチェックすべき一般的な設計上の欠陥をリストアップしました。ぜひ、このリストを活用し、自分の設計したスキーマを批判的に見直し、改善の可能性を探ってみてください。

## ファクトテーブルの粒度（グレイン）は明確か？

データウェアハウスチームが誇らしげにディメンショナルモデルの設計を披露する際、私たちが最初に尋ねるのは「ファクトテーブルの粒度（グレイン）は何か？」という質問です。これは、ファクトテーブルに格納されるデータの具体的な詳細レベルを指します。しかし、驚くことに、この質問に対して一貫性のない回答が返ってくることがよくあります。

ファクトテーブルの粒度を明確に定義することは、効果的なモデリングを行う上で不可欠です。これが曖昧なままだと、設計チームやビジネス担当者との議論が堂々巡りになってしまいます。

最大限の柔軟性と拡張性を確保するためには、ファクトテーブルは可能な限り最も細かい粒度で作成すべきです。 詳細なデータは集約することができますが、すでに集約されたデータしかない場合、より詳細なレベルにドリルダウンすることはできません。もちろん、最適な粒度はモデリングするビジネスプロセスによって異なります。

## 混在した粒度やテキストのファクトが含まれていないか？

ファクトテーブルの粒度を決めたら、その粒度に適合するファクト（数値データ）を特定します。例えば、一部のファクトが明細レベルの指標である一方で、他のファクトがヘッダーレベルの指標である場合、ヘッダーレベルのファクトを明細レベルに分配するか、ヘッダーレベルの粒度を持つ別のファクトテーブルを作成する必要があります。

ファクトテーブルには通常、外部キーと、ビジネスパフォーマンスを測定する数値データ（カウントや金額など）が含まれます。理想的には、ファクトは加算可能（additive）であるべきです。つまり、どのディメンションに対しても合計できることが望ましいです。

また、年初来累計（year-to-date total）などの集計済みのファクトをファクトテーブルに含めるのは危険です。 これらは完全に加算可能ではなく、誤って二重計算されるリスクがあります。

さらに、テキストフィールド（フラグや指標など）をファクトテーブルに含めるべきではありません。 これらは、サロゲートキー（代理キー）よりも多くのスペースを消費するだけでなく、ビジネスユーザーがクエリやレポートで利用したい場合、ディメンションテーブルに格納した方が柔軟性が高まります。

## ディメンションの識別子と説明が適切に設定されているか？

ディメンションテーブル内の識別子やコードには、必ず説明（デコード）を付けるべきです。 「ビジネスユーザーはコードを好む」という誤解は捨てましょう。実際にビジネスユーザーのオフィスを訪れると、コードのデコードリストが掲示板やモニターに貼られているのをよく見かけます。

また、データアクセスアプリケーション内でフィルタリングやラベル付けのロジックを埋め込むのではなく、ディメンションテーブルでサポートするべきです。 これにより、レポートのラベル付けが一貫し、変更の影響を最小限に抑えることができます。

## 階層の扱いは適切か？

各ディメンションは、ファクトテーブルの各行に対して一意の値を持つべきです。同様に、各ディメンション属性も、ディメンションテーブルの各行に対して一意の値を持つべきです。

設計者の中には、ディメンションの階層をファクトテーブル内で管理しようとすることがあります。例えば、商品ディメンションの代わりに、ブランド、カテゴリ、部門などのキーをファクトテーブルに直接含めるケースです。これにより、ファクトテーブルが不要に複雑化し、結合するディメンションテーブルの数が増えてしまいます。

また、スノーフレーク（正規化）を避けるべきです。 ディメンションテーブルを正規化すると、ディスクスペースの節約にはなるかもしれませんが、クエリのパフォーマンスや使いやすさの面でデメリットが大きくなります。

## 日付ディメンションを明示的に使用しているか？

すべてのファクトテーブルには、少なくとも 1 つの外部キーとして日付ディメンションを持たせるべきです。SQL の標準的な日付関数では、会計年度、季節、祝日などの属性を適切に処理できません。これらの情報は、日付ディメンションテーブルに格納するのが適切です。

また、月ごとのデータを 1 行にまとめるのではなく、各月を個別の行として格納するべきです。固定された時間スロットを持つ設計は、アクセスやメンテナンスの面で問題を引き起こす可能性があります。

## 制御番号は退化ディメンションとして扱っているか？

トランザクション型のファクトテーブルでは、注文番号や請求書番号などの制御番号を退化ディメンション（degenerate dimension）として扱うべきです。これらはファクトテーブル内にキーとして保持しますが、対応するディメンションテーブルを持ちません。

## サロゲートキーを使用しているか？

ディメンションの主キーやファクトテーブルの外部キーには、業務システムのキーではなく、意味を持たないサロゲートキーを使用すべきです。これにより、業務システムの変更（例: アカウント番号の再利用）からデータウェアハウスを保護できます。

## Slowly Changing Dimensions (SCD) の戦略を決めているか？

ディメンショナル設計を完成させるには、各ディメンション属性に対して、Slowly Changing Dimensions（SCD）の管理方法を決める必要があります。

- 上書きする
- 新しい行を追加する
- 新しい列を追加する
- 新しいディメンションを作成する

これらの戦略を事前にしっかり検討しておくことが重要です。

## ビジネス要件を十分に理解しているか？

効果的なデザインレビューを行うには、ビジネス要件とデータの実態を深く理解していることが不可欠です。ビジネスの専門家や担当者と密に連携し、設計の妥当性を確認しましょう。

このリストを活用し、自分のディメンショナルモデルを評価してみてください。素晴らしい設計ができることを願っています！ 🚀

[Fistful of Flaws](https://www.kimballgroup.com/2003/10/fistful-of-flaws/)

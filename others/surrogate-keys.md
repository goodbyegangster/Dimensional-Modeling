# Surrogate Keys

Webster’s Unabridged Dictionary によれば、`surrogate（サロゲート）` とは「自然なものの代替として用いられる人工的または合成的な産物」であるとされています。これは、データウェアハウスで使用するサロゲートキーを説明するのにまさに的確な定義です。サロゲートキーとは、ナチュラルキーの代わりに使われる人工的または合成的なキーのことです。

もっとも、データウェアハウスにおけるサロゲートキーは単なるナチュラルキーの代替ではありません。サロゲートキーは 自然な業務キーを一般化した、データウェアハウス設計における基本的要素です。

ここではっきりさせておきましょう。データウェアハウス環境におけるディメンションとファクトの結合は、ナチュラルキーではなくサロゲートキーを使う必要があります。

データ抽出処理のロジックは、データウェアハウスにディメンションレコードやファクトレコードを取り込むたびに、入力のナチュラルキーを必ず対応するサロゲートキーで置き換える必要があります。

## サロゲートキーの仕組み

つまり、製品ディメンションとファクトテーブルの結合でも、顧客ディメンションとファクトテーブルの結合でも、さらには時間ディメンションとの結合でさえも、その物理的な結合キーはソースデータから直接持ち込まれたナチュラルキーではなく、匿名の整数であるサロゲートキーであるべきです。

そして、サロゲートキーは次のようではあってはなりません。

- スマートキー（キーを見ただけでレコードの意味が分かるようなもの）
- ナチュラルキーを単純に組み合わせた複合キー

## ナチュラルキーを使う場合の問題点

もしあなたがプロの DBA なら注意を引いたかもしれません。逆にデータウェアハウス初心者なら「ぞっとする」かもしれません。

「自分の訓練では、与えられたデータからキーを作るように教わったのに？」と思うでしょう。

確かにトランザクション処理（運用環境）では、製品キーや顧客キーの意味はレコード内容に直接結びつきます。しかし、データウェアハウス環境では、ディメンションテーブルのキーはその内容を一般化したものである必要があります。

## ナチュラルキー（プロダクションキー）と独立すべき理由

データウェアハウスマネージャーとしては、ナチュラルキー（プロダクションキー）を独立させる必要があります。なぜなら、運用（プロダクション）とデータウェアハウスでは優先順位が違うからです。

プロダクションの製品キーや顧客キーは、業務都合により生成、書式変更、更新、削除、再利用が行われます。そのまま使うと振り回され、大きな被害につながります。以下は、ナチュラルキー（プロダクションキー）に依存すると起こりうる問題例です。

- ナチュラルキー（プロダクションキー）が再利用される
  - 間違って再利用してしまうこともある（小売業の UPC コードでよく起こる）
- ガーベジコレクション的理由でキー体系を再割り当てすることがある
- 製品説明や顧客説明を新しい値に更新しても、キー自体は変えないことがある
- 新しい状況に対応するため、キーのフォーマットを整数から英数字に一般化することがある
- または、キーサイズを 12 バイトから 20 バイトに拡大する場合もある
- M&A で新しいシステムと統合する場合、それぞれ異なるキー体系を持ち込まなければならない

このように、ナチュラルキー（プロダクションキー）には常に破壊的変化のリスクがあります。

## Slowly Changing Dimension (SCD) の問題

「SCD 問題」はデータウェアハウスで広く知られた論点です。

ディメンションレコード（製品や顧客）の説明属性が変わってしまった場合、通常の対応は 「新しいディメンションレコードを発行する」 ことです。

これを可能にするには、ナチュラルキーに依存しない、より一般的なキー構造＝サロゲートキーが必要になります。

## 不確実な知識の表現

サロゲートキーには、もうひとつ重要な役割があります。それは `不確実な情報を符号化できること` です。

例えば、取引に顧客キーを割り当てねばならないのに、顧客が特定できない場合があります。現金決済のスーパーで顧客不明になる典型的なケースです。この場合、「匿名顧客」を表す特別なサロゲートキーを作ることができます。これは一般に「ハック」と呼ばれます。

さらに場面に応じて細かく区別したいかもしれません。

- 「顧客 ID まだ未取得」
- 「顧客は存在するが処理システムが正しく報告しなかった」
- 「そもそも顧客が存在するはずのない状況」

これらはいずれもプロダクション顧客キーからは生成できないため、データウェアハウスはサロゲートキーを必要とします。なお、スキーマ上、すべてのファクトレコードには必ず顧客キーが必要です。ファクトテーブルの外部キーは Null になりえません。

### 日付の「不明」問題

「不明（I don't know）」は日付でもよく発生します。ファクトとディメンションを日付キーで結合している場合、必ず「実在する日付」で代替する必要があります。`2000 年 1 月 1 日` を「不明日付」に使うのは最悪です。これは「プロダクションキー問題」と「2000 年問題」を同時に抱え込むようなものです。

### 「スマートキー」に頼る誤り

「キーを直接アプリで扱えれば、ディメンションとの結合を避けられる」と考えてスマートキーを残している例もあります。しかしこれは間違いです。

例えばキーからメーカー ID を解読できるなら、その情報はディメンションテーブルに普通の列として持つべきです。さらに、分かりやすい「メーカー名」列を追加するべきです。アルファベット ID そのものはむしろ廃棄した方がよいでしょう。

日付キーも同様です。キーを直接操作することで結合を避けても、カレンダー情報はディメンションにしかありません。結果的にアプリケーションにカレンダーロジックを埋め込んでしまうことになり、大きな戦略的失敗となります。カレンダーの知識はアプリではなくディメンションに置かれるべきです。

## サロゲートキーの利点まとめ

### ストレージ節約

整数値のサロゲートキーを使えば、ストレージ・スペースを大幅に節約できるかもしれません。

10 億行のデータを持つ大きなファクトテーブルがあるとします。このようなテーブルでは、各行の 1 バイトが無駄になると、合計で 1 ギガバイトのストレージになります。4 バイト整数キーの優れた点は、20 億以上の異なる値を表現できることです。これは、どのようなディメンジョンでも（いわゆるモンスターディメンジョンと呼ばれる個々の人間を表すディメンジョンでも）十分な量となります。そのため、長い顧客 ID も、長い製品・在庫管理情報も、日付スタンプも、すべて 4 バイトのキーに圧縮でき、何ギガバイトものストレージを節約できます。

### パフォーマンス改善（推定）

大きく複雑なナチュラルキーや複合キーを「小さな整数キー」に置き換えることで、結合性能が改善されると強く考えられます。ストレージが減り、インデックス検索も単純になるはずです。

## サロゲートキーの生成

最後に、実際の生成について。基本的には、入力データのナチュラルキーを検知するたびに、対応するサロゲートキーをルックアップし置き換える必要があります。これはステージング領域での日々の抽出・変換処理において重要なステップです。従って、このルックアップはできる限り単純で高速になるよう工夫する必要があります。

[Surrogate Keys](https://www.kimballgroup.com/1998/05/surrogate-keys/)

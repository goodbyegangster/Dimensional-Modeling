# Design Tip #158 Making Sense of the Semantic Layer

ビジネスインテリジェンス（BI）アーキテクチャの主要な構成要素のひとつがセマンティックレイヤーです。セマンティックレイヤーは、基盤となるデータベース構造をビジネスユーザーが理解できる用語や構造に「翻訳」して提供します。通常はクエリ／レポートツールの一部として組み込まれています。OLAP やキューブ型データベースもまた、BI のセマンティックレイヤーを備えています。

セマンティックレイヤーには、非常に最小限の機能しか持たないものから、豊富で堅牢なものまで様々なバリエーションがあります。

セマンティックレイヤーとして最低限備えているべき機能は、以下の通りです。

### セマンティックレイヤーの最低限の役割

1. データをビジネスユーザーが直感的に理解できる整理構造の提供

多くのツールでは、テーブルやカラムを「フォルダ構造」に整理して表示します。

Kimball メソッドではデータウェアハウスをディメンショナルモデリングで設計するよう強く推奨しています。これは、トランザクション DB の構造をそのままユーザーに見せるアプローチよりも格段に優れています。

きちんとディメンショナルモデルの上に構築したとしても、セマンティックレイヤーを導入することで「ナビゲーション性」や「発見しやすさ」がさらに向上します。

2. ビジネスユーザーにとって意味のある名前付けの機会

Kimball メソッドでは「テーブルやカラムは最初からユーザーにとって自然な名前にすべき」と推奨していますが、実際にはこのリネーミング機能がセマンティックレイヤーで実装される場合もあります。

3. ビジネス視点でのデータ要素の説明（メタデータ）の保持

理想的には複数の形態のメタデータ（ビジネス上の意味、値の例、ディメンション属性の変更ポリシー）を格納・提供すべきです。

完璧を言えば、さらに以下も追跡できるのが望ましいでしょう。

- 元となったトランザクションシステム上のデータ要素
- どの ETL ジョブがこの属性を処理したか
- いつデータウェアハウスにロードされたか

実際にはほとんどのセマンティックレイヤーは、1 項目につきせいぜい簡単な説明を格納できる程度であり、現場でもその説明すら埋めていないのが実情です。

4. 計算式や集計ルールの定義

例えば「在庫残高は多くのディメンションに対しては加算可能だが、時間をまたいだ集計の場合は期末残高を取る、あるいは残高の合計を期間数で割るべき」といった集計ロジックをセマンティックレイヤーで定義できます。

### セマンティックレイヤーは必須か？

もし DW/BI システムをアドホック利用に開放するなら絶対に必要です。豊かなセマンティックレイヤーを構築するためにかけた時間は、ユーザーの採用率・成功率として必ず回収できます。

BI ツールに付属する「ウィザード」をただ実行して、テーブルと同等のセマンティックレイヤーを作るだけでは不十分です（たとえディメンショナルモデル上であっても）。できる限り理にかなった、洗練されたレイヤーを構築すべきです。

### セマンティックレイヤーの「弱点」

唯一の欠点は、複数回の投資が必要になることです。多くの組織では、ユーザーごとのニーズの多様性を満たすために複数の BI ツールが必要となり、それぞれ独自のセマンティックレイヤーを持ちます。たとえ同一ベンダーのツールであっても、セマンティックレイヤーを流用できることは稀です。

BI チームが直面する課題のひとつは、各 BI ツールで「見た目」や「組織化の構造」をなるべく揃えることです。この点でも、Kimball メソッドの「ディメンショナル設計を正しく行う」という方針は、BI ツールごとのセマンティックレイヤーをシンプルにし、この作業を大幅に容易にします。

### セマンティックレイヤーを使わない唯一のケース

唯一「セマンティックレイヤーなしでもよい」と考えられるシナリオは次のような場合です。

- DW/BI システムへのアクセスがアドホックユーザーに一切開放されていない
- すべてのアクセスが専門のレポート開発者を通じて調整される

理論的には可能ですが、これは冷淡かつ非合理的な選択肢です。

- そもそも、アドホックユーザーを完全に閉め出すことなどどうして可能でしょうか？それは無茶な話です
- さらに、レポート開発者だって人間です。たしかに SQL を手で書き、外部データ辞書を参照することはできますが、わざわざ苦行を強いる必要もありません

### 「ディメンショナルウェアハウスは不要」論について

「セマンティックレイヤーがあればリレーショナルのデータウェアハウスは不要」と一部の人（特に BI ツールベンダー）は主張します。つまり「ETL は作りたくないからセマンティックレイヤーだけで済ませよう」という考えです。これは魅力的に聞こえますが、実際には幻想にすぎません。

- セマンティックレイヤーは ETL ツールの変換・統合機能を提供できません
- BI ツールは本来強みを持つ部分（分析や可視化）に集中させるべきです。ETL まがいのことをやらせてはいけません
- ETL の「バックルーム」工程が提供する価値（クリーニング、標準化、共通化、重複排除）は BI ツールでは実現できません

### セマンティックレイヤーをトランザクション上に直接構築するケース

実際、私はクライアントが正規化モデル（トランザクション DB や ODS）に直接 BI ツールを接続してセマンティックレイヤーを作成する例を見てきました。

よくあるパターンは以下の 2 つです。

- 1. プロトタイプ用途
  - Business Objects の Universe や Tableau の画面をデモし、エンタープライズデータウェアハウスへの投資や支持を引き出す
- 2. オペレーショナルレポート用途
  - トランザクションシステムの上にセマンティックレイヤーをかぶせ、運用報告を満たす

ただし、多くの場合この「運用向けセマンティックレイヤー」は、あくまでエンタープライズ分析環境の中のごく一部であり、本格的なデータウェアハウスを伴っています。

「トランザクションシステムが十分きれいで、分析ニーズも単純だからディメンショナルモデルは不要」と言い張る組織には、私は懐疑的です。理論として完全否定はしませんが、実際にうまくいった事例を見たことはありません。

### 投資のバランスについて

私は「セマンティックレイヤーに投資しすぎて失敗した」事例を見たことは一度もありません。 しかし、「セマンティックレイヤーへの投資不足でデータウェアハウスが失敗した」事例は数えきれないほど見てきました。

まずは適切な BI ツールを選び、セマンティックレイヤーの開発に十分時間をかけてください。でなければ、技術的にしっかり設計・実装されたデータウェアハウス自体の大きな投資を、自ら無駄にしてしまうことになります。

[Design Tip #158 Making Sense of the Semantic Layer](https://www.kimballgroup.com/2013/08/design-tip-158-making-sense-of-the-semantic-layer/)
